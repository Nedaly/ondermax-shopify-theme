<div id="StickyATC-{{ section.id }}" class="sticky-atc-wrapper" data-section-id="{{ section.id }}" data-scroll-threshold="{{ section.settings.scroll_threshold }}">
    <div class="page-width sticky-atc-content">
        {%- if section.settings.show_image -%}
            <div class="product-image">
                {%- if product.featured_media -%}
                    <img src="{{ product.featured_media | image_url: width: 100 }}" alt="{{ product.featured_media.alt | escape }}" loading="lazy">
                {%- endif -%}
            </div>
        {%- endif -%}
        
        {%- if section.settings.show_title or section.settings.show_price -%}
            <div class="product-info">
                {%- if section.settings.show_title -%}
                    <h3 class="product-title">{{ product.title }}</h3>
                {%- endif -%}
                {%- if section.settings.show_price -%}
                    <div class="price-wrapper">
                        <span class="price">{{ product.selected_or_first_available_variant.price | money }}</span>
                        {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price and section.settings.show_sale_badge -%}
                            <span class="sale-badge">{{ 'products.product.on_sale' | t }}</span>
                        {%- endif -%}
                    </div>
                {%- endif -%}
            </div>
        {%- endif -%}
        
        <div class="action-buttons">
            {%- if section.settings.show_variant_picker and product.variants.size > 1 -%}
                <select class="variant-picker" id="StickyATCVariantPicker-{{ section.id }}">
                    {% for variant in product.variants %}
                        <option value="{{ variant.id }}" {% if variant == product.selected_or_first_available_variant %}selected{% endif %}>
                            {{ variant.title }} - {{ variant.price | money }}
                        </option>
                    {% endfor %}
                </select>
            {%- endif -%}
            
            <button type="button" class="sticky-atc-button button button--primary" data-add-to-cart>
                <span class="button-text">{{ section.settings.button_label | default: 'Add to Cart' }}</span>
                <span class="loading-spinner hidden">{% render 'icon-spinner' %}</span>
                <span class="success-icon hidden">{% render 'icon-check' %}</span>
            </button>
        </div>
    </div>
</div>

<style>
    .sticky-atc-wrapper {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffffff;
        border-top: 1px solid #e5e5e5;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .sticky-atc-wrapper.visible {
        transform: translateY(0);
    }

    .sticky-atc-content {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
    }

    .product-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-info {
        flex: 1;
        min-width: 0;
    }

    .product-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .price-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .price {
        font-size: 16px;
        font-weight: 700;
        color: #333;
    }

    .sale-badge {
        font-size: 12px;
        color: #e74c3c;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .variant-picker {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        min-width: 120px;
    }

    .sticky-atc-button {
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-width: 120px;
    }

    .sticky-atc-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .sticky-atc-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .loading-spinner,
    .success-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .hidden {
        display: none;
    }

    /* Mobile-first responsive design */
    @media screen and (max-width: 768px) {
        .sticky-atc-content {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }

        .product-info {
            width: 100%;
            justify-content: center;
        }

        .action-buttons {
            width: 100%;
            justify-content: center;
        }

        .sticky-atc-button {
            flex: 1;
            min-width: auto;
        }

        .variant-picker {
            min-width: 100px;
        }
    }

    @media screen and (max-width: 480px) {
        .product-title {
            font-size: 14px;
        }

        .price {
            font-size: 16px;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stickyATC = document.getElementById('StickyATC-{{ section.id }}');
    const scrollThreshold = {{ section.settings.scroll_threshold | default: 300 }};
    const variantPicker = document.getElementById('StickyATCVariantPicker-{{ section.id }}');
    const addToCartButton = stickyATC.querySelector('[data-add-to-cart]');
    
    if (!stickyATC) return;

    // Show/hide sticky ATC based on scroll
    function handleScroll() {
        if (window.scrollY > scrollThreshold) {
            stickyATC.classList.add('visible');
        } else {
            stickyATC.classList.remove('visible');
        }
    }

    // Handle variant change
    if (variantPicker) {
        variantPicker.addEventListener('change', function() {
            const variantId = this.value;
            // Update product info if needed
            console.log('Variant changed to:', variantId);
        });
    }

    // Handle add to cart
    if (addToCartButton) {
        addToCartButton.addEventListener('click', function() {
            const button = this;
            const buttonText = button.querySelector('.button-text');
            const loadingSpinner = button.querySelector('.loading-spinner');
            const successIcon = button.querySelector('.success-icon');
            
            // Show loading state
            button.disabled = true;
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            // Simulate add to cart (replace with actual cart logic)
            setTimeout(() => {
                // Show success state
                loadingSpinner.classList.add('hidden');
                successIcon.classList.remove('hidden');
                buttonText.textContent = 'Added!';
                buttonText.classList.remove('hidden');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.disabled = false;
                    successIcon.classList.add('hidden');
                    buttonText.textContent = '{{ section.settings.button_label | default: "Add to Cart" }}';
                }, 2000);
            }, 1000);
        });
    }

    // Add scroll listener
    window.addEventListener('scroll', handleScroll);
    
    // Initial check
    handleScroll();
});
</script>

{% schema %}
{
    "name": "Sticky Add to Cart",
    "settings": [
        {
            "type": "text",
            "id": "button_label",
            "label": "Button Label",
            "default": "Add to Cart"
        },
        {
            "type": "checkbox",
            "id": "show_image",
            "label": "Show Product Image",
            "default": true
        },
        {
            "type": "checkbox",
            "id": "show_title",
            "label": "Show Product Title",
            "default": true
        },
        {
            "type": "checkbox",
            "id": "show_price",
            "label": "Show Price",
            "default": true
        },
        {
            "type": "checkbox",
            "id": "show_sale_badge",
            "label": "Show Sale Badge",
            "default": true
        },
        {
            "type": "checkbox",
            "id": "show_variant_picker",
            "label": "Show Variant Picker",
            "default": false
        },
        {
            "type": "range",
            "id": "scroll_threshold",
            "label": "Scroll Threshold (px)",
            "min": 100,
            "max": 1000,
            "step": 50,
            "default": 300
        }
    ],
    "presets": [
        {
            "name": "Sticky Add to Cart"
        }
    ]
}
{% endschema %}
